<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#007aff">
<title>Inventory Counter</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; -webkit-overflow-scrolling:touch; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        background:#f5f5f7; padding:10px; line-height:1.5; }
.header { background:white; padding:15px; border-radius:12px; margin-bottom:15px;
          box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; }
.header h1 { font-size:22px; margin-bottom:10px; text-align:center; }
.progress-bar { width:100%; height:8px; background:#e5e5ea; border-radius:4px;
                overflow:hidden; margin:10px 0; }
.progress-fill { height:100%; background:linear-gradient(90deg,#00c853,#64dd17);
                 width:0%; transition:width .3s ease; }
.stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;
         font-size:13px; color:#666; text-align:center; }
.stat-value { font-size:18px; font-weight:bold; color:#1d1d1f; }
.controls { background:white; padding:15px; border-radius:12px; margin-bottom:15px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.search-box { width:100%; padding:12px; font-size:16px; border:2px solid #e5e5ea;
              border-radius:8px; margin-bottom:10px; }
.control-btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.btn { padding:12px; font-size:15px; font-weight:600; border:none;
       border-radius:8px; cursor:pointer; transition:all .2s; }
.btn:active { transform:scale(.95); }
.btn-primary { background:#007aff; color:white; }
.btn-success { background:#34c759; color:white; }
.btn-danger  { background:#ff3b30; color:white; }
.item-card { background:white; padding:18px; border-radius:12px; margin-bottom:15px;
             box-shadow:0 2px 8px rgba(0,0,0,0.1); border-left:5px solid #007aff;
             transition:all .3s; position:relative; }
.item-card.counted   { border-left-color:#34c759; opacity:.8; }
.item-card.notfound  { border-left-color:#ff9500; opacity:.8; }
.item-card.custom    { border-left-color:#9333ea; }
.item-card.highlight { background:#fffbe6; transition:background .3s; }
.item-number { display:inline-block; background:#007aff; color:white;
               padding:4px 10px; border-radius:12px; font-size:11px;
               font-weight:bold; margin-bottom:8px; }
.item-part   { font-size:17px; font-weight:bold; color:#1d1d1f; margin-bottom:5px; }
.item-desc   { font-size:13px; color:#666; margin-bottom:8px; }
.item-category { display:inline-block; background:#f5f5f7; padding:4px 10px;
                 border-radius:12px; font-size:11px; color:#666; margin-bottom:8px; }
.item-prev   { font-size:13px; color:#666; margin-bottom:10px; }
.count-input { width:100%; padding:14px; font-size:22px; font-weight:bold;
               border:3px solid #007aff; border-radius:8px; text-align:center;
               margin:10px 0; }
.quick-buttons { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px;
                 margin:10px 0; }
.quick-btn { padding:12px; background:#f5f5f7; border:2px solid #e5e5ea;
             border-radius:8px; font-size:16px; font-weight:bold;
             cursor:pointer; transition:all .2s; }
.quick-btn:active { background:#e5e5ea; transform:scale(.95); }
.quick-btn.minus   { background:#ff3b30; color:white; border-color:#ff3b30; }
.quick-btn.plus    { background:#34c759; color:white; border-color:#34c759; }
.quick-btn.notfound{ background:#ff9500; color:white; border-color:#ff9500; }
.notes-input { width:100%; padding:12px; font-size:14px; border:2px solid #e5e5ea;
               border-radius:8px; margin:10px 0; min-height:60px; resize:vertical; }
.mark-btn { width:100%; padding:14px; font-size:17px; font-weight:bold;
            background:#34c759; color:white; border:none; border-radius:8px;
            cursor:pointer; margin-top:10px; transition:all .2s; }
.mark-btn:active { background:#2ba349; transform:scale(.98); }
.delete-btn { position:absolute; top:8px; right:8px; background:#ff3b30;
              color:white; border:none; border-radius:50%; width:32px; height:32px;
              font-size:18px; cursor:pointer; opacity:0; transition:opacity .3s; }
.item-card:hover .delete-btn, .item-card:active .delete-btn { opacity:1; }
.add-item-section { background:#9333ea; color:white; padding:18px;
                    border-radius:12px; margin-bottom:15px; }
.add-item-section h3 { margin-bottom:12px; font-size:16px; }
.add-input { width:100%; padding:12px; font-size:15px; border:2px solid white;
             border-radius:8px; margin-bottom:10px; background:rgba(255,255,255,.2);
             color:white; }
.add-input::placeholder { color:rgba(255,255,255,.7); }
.import-section { background:#5856d6; color:white; padding:18px;
                  border-radius:12px; margin-bottom:15px; text-align:center; }
#importFile { display:none; }
.import-btn { background:rgba(255,255,255,.2); border:2px dashed white;
              padding:15px; border-radius:8px; cursor:pointer; }

/* Toast */
.toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
         background:rgba(0,0,0,.8); color:white; padding:10px 20px;
         border-radius:8px; font-size:14px; z-index:1000; opacity:0;
         transition:opacity .3s; }
.toast.show { opacity:1; }
</style>
</head>
<body>

<div class="header">
  <h1>Inventory Counter</h1>
  <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
  <div class="stats">
    <div><div class="stat-value" id="counted">0</div><div>Counted</div></div>
    <div><div class="stat-value" id="notfound">0</div><div>Not Found</div></div>
    <div><div class="stat-value" id="remaining">131</div><div>Remaining</div></div>
    <div><div class="stat-value" id="totalItems">131</div><div>Total</div></div>
  </div>
</div>

<div class="controls">
  <input type="text" class="search-box" id="searchBox" placeholder="Search part or desc...">
  <div class="control-btns">
    <button class="btn btn-primary" id="btnUncounted">Uncounted</button>
    <button class="btn btn-primary" id="btnShowAll">Show All</button>
    <button class="btn btn-success" id="btnExport">Export CSV</button>
    <button class="btn btn-danger" id="btnReset">Reset</button>
  </div>
</div>

<div class="import-section">
  <h3>Import CSV File</h3>
  <label class="import-btn" for="importFile">Choose CSV File</label>
  <input type="file" id="importFile" accept=".csv">
</div>

<div class="add-item-section">
  <h3>Add New Item</h3>
  <input type="text" class="add-input" id="newPart" placeholder="Part Number">
  <input type="text" class="add-input" id="newDesc" placeholder="Description">
  <input type="text" class="add-input" id="newCat" placeholder="Category (optional)">
  <button class="btn btn-success" style="width:100%;margin-top:10px;" id="btnAddItem">Add Item</button>
</div>

<div id="items"></div>

<div id="toast" class="toast">Saved!</div>

<script>
/* ---------- DATA ---------- */
let items   = {};   // { id: {part,desc,cat,prev} }
let counts  = {};   // { id: {counted, notfound, count, notes, timestamp} }
let nextId  = 0;
let itemOrder = [];

/* ---------- DEFAULT 131 ITEMS (first run only) ---------- */
const defaultItems = [
  {part:"TR40VA002",desc:"Transformer, 40 VA, 120 to 24 Vac, Foot and Dual Threaded Hub Mount",cat:"Transformer",prev:"1"},
  {part:"SAM-V",desc:"SAM-V—VAV Controller",cat:"Controller",prev:"4"},
  {part:"ZTH100",desc:"ZTH100 – Handheld Service Tool",cat:"Tool",prev:"2"},
  {part:"P2-100",desc:"Pressure Sensor 0-100 Pa",cat:"Sensor",prev:"3"},
  {part:"VAV-100",desc:"VAV Actuator 0-10 V",cat:"Actuator",prev:"5"},
  // ... 126 more items ...
  {part:"LAD8N20",desc:"TeSys Deca, auxiliary contact block, 2 NO, side mount, screw clamp terminals, for LC1D09 to LC1D150 contactors",cat:"Contactor Accessory",prev:"2"}
];

/* ---------- PERSISTENCE ---------- */
function loadAll() {
  const savedItems   = localStorage.getItem('invItems');
  const savedCounts  = localStorage.getItem('invCounts');
  const savedNextId  = localStorage.getItem('invNextId');
  const savedOrder   = localStorage.getItem('invOrder');

  if (savedItems)   items   = JSON.parse(savedItems);
  else              items   = {};

  if (savedCounts)  counts  = JSON.parse(savedCounts);
  else              counts  = {};

  nextId = savedNextId ? parseInt(savedNextId) : 0;
  itemOrder = savedOrder ? JSON.parse(savedOrder) : [];

  // First run: populate defaults
  if (Object.keys(items).length === 0) {
    defaultItems.forEach((it, idx) => {
      const id = idx;
      items[id] = it;
      itemOrder.push(id);
    });
    nextId = defaultItems.length;
  }

  // Fix nextId if needed
  if (nextId <= Math.max(...Object.keys(items).map(Number), -1)) {
    nextId = Math.max(...Object.keys(items).map(Number)) + 1;
  }
}

function autoSave() {
  localStorage.setItem('invItems',  JSON.stringify(items));
  localStorage.setItem('invCounts', JSON.stringify(counts));
  localStorage.setItem('invNextId', nextId);
  localStorage.setItem('invOrder',  JSON.stringify(itemOrder));
  updateStats();
  renumberItems();
  showToast();
}

function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  clearTimeout(t.timer);
  t.timer = setTimeout(() => t.classList.remove('show'), 1000);
}

/* ---------- UI ---------- */
function renumberItems() {
  const cards = document.querySelectorAll('.item-card');
  cards.forEach((c, i) => {
    c.querySelector('.item-number').textContent = `#${i+1} of ${cards.length}`;
  });
  document.getElementById('totalItems').textContent = cards.length;
}

function updateStats() {
  let counted = 0, notfound = 0;
  for (const id in counts) {
    if (counts[id].notfound) notfound++;
    else if (counts[id].counted) counted++;
  }
  const total = Object.keys(items).length;
  const remaining = total - counted - notfound;

  document.getElementById('counted').textContent    = counted;
  document.getElementById('notfound').textContent  = notfound;
  document.getElementById('remaining').textContent = remaining;

  const prog = total ? ((counted + notfound) / total) * 100 : 0;
  document.getElementById('progressBar').style.width = prog + '%';
}

function createCard(id) {
  const it = items[id];
  const card = document.createElement('div');
  card.className = 'item-card';
  card.id = 'card' + id;
  card.dataset.id = id;
  card.dataset.part = it.part;

  card.innerHTML = `
    <span class="item-number"></span>
    <div class="item-part">${it.part}</div>
    <div class="item-desc">${it.desc}</div>
    <span class="item-category">${it.cat}</span>
    <div class="item-prev">Previous: <strong>${it.prev}</strong></div>
    <input type="number" class="count-input" id="c${id}" value="" placeholder="0">
    <div class="quick-buttons">
      <button class="quick-btn minus"   data-id="${id}" data-val="-1">-</button>
      <button class="quick-btn plus"    data-id="${id}" data-val="1">+</button>
      <button class="quick-btn copy-prev" data-id="${id}">Copy Prev</button>
      <button class="quick-btn notfound" data-id="${id}">Not Found</button>
    </div>
    <textarea class="notes-input" id="n${id}" placeholder="Notes..."></textarea>
    <button class="mark-btn" data-id="${id}">Mark as Counted</button>
    <button class="delete-btn" data-id="${id}">X</button>
  `;

  const saved = counts[id];
  if (saved) {
    const inp = card.querySelector(`#c${id}`);
    const txt = card.querySelector(`#n${id}`);
    if (saved.notfound) {
      card.classList.add('notfound');
      inp.value = '0';
      txt.value = saved.notes || 'NOT FOUND';
    } else if (saved.counted) {
      card.classList.add('counted');
      inp.value = saved.count || '';
      txt.value = saved.notes || '';
    }
  }
  return card;
}

function buildList() {
  const container = document.getElementById('items');
  container.innerHTML = '';
  itemOrder.forEach(id => {
    if (items[id]) container.appendChild(createCard(id));
  });
}

/* ---------- IMPORT CSV ---------- */
document.getElementById('importFile').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseCSV(ev.target.result);
  reader.readAsText(file);
});

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const seen = new Set();
  let imported = 0;

  lines.forEach((line, i) => {
    if (i === 0 && line.includes('Part')) return;
    const cols = line.split(',').map(s => s.replace(/^"|"$/g, '').trim());
    if (cols.length < 2) return;
    const part = cols[0], desc = cols[1], cat = cols[2] || 'Unknown', prev = cols[3] || '0';
    if (seen.has(part)) return;
    seen.add(part);
    const id = nextId++;
    items[id] = {part, desc, cat, prev};
    itemOrder.push(id);
    imported++;
  });
  buildList();
  autoSave();
  alert(`Imported ${imported} items!`);
}

/* ---------- DOM READY ---------- */
document.addEventListener('DOMContentLoaded', () => {
  loadAll();
  buildList();
  updateStats();
  renumberItems();

  /* ----- EVENTS ----- */
  document.addEventListener('click', e => {
    const t = e.target;

    if (t.matches('.quick-btn.plus') || t.matches('.quick-btn.minus')) {
      const id = t.dataset.id;
      const inp = document.getElementById('c' + id);
      let v = parseInt(inp.value) || 0;
      v += parseInt(t.dataset.val);
      if (v < 0) v = 0;
      inp.value = v;
      counts[id] = { ...counts[id], count: v.toString() };
      autoSave();
    }

    if (t.matches('.quick-btn.copy-prev')) {
      const id = t.dataset.id;
      const prev = document.querySelector(`#card${id} .item-prev strong`).textContent;
      const inp = document.getElementById('c' + id);
      inp.value = prev;
      counts[id] = { ...counts[id], count: prev };
      autoSave();
    }

    if (t.matches('.quick-btn.notfound')) {
      const id = t.dataset.id;
      const card = document.getElementById('card' + id);
      const inp = document.getElementById('c' + id);
      const txt = document.getElementById('n' + id);
      counts[id] = { notfound:true, count:'0', notes:'NOT FOUND', timestamp:new Date().toISOString() };
      card.className = 'item-card notfound';
      inp.value = '0';
      txt.value = 'NOT FOUND';
      autoSave();
    }

    if (t.matches('.mark-btn')) {
      const id = t.dataset.id;
      const inp = document.getElementById('c' + id);
      const txt = document.getElementById('n' + id);
      const card = document.getElementById('card' + id);
      const val = inp.value.trim();
      if (val === '' || isNaN(val)) { alert('Enter a valid number!'); return; }
      counts[id] = { counted:true, count:val, notes:txt.value, timestamp:new Date().toISOString() };
      card.className = 'item-card counted';
      autoSave();
    }

    if (t.matches('.delete-btn')) {
      if (!confirm('Delete this item?')) return;
      const id = t.dataset.id;
      document.getElementById('card' + id).remove();
      delete items[id];
      delete counts[id];
      itemOrder = itemOrder.filter(x => x != id);
      autoSave();
    }
  });

  document.addEventListener('blur', e => {
    if (e.target.classList.contains('count-input')) {
      const id = e.target.id.slice(1);
      const v = e.target.value.trim();
      if (v !== '' && !isNaN(v)) {
        counts[id] = { ...counts[id], count: v };
        autoSave();
      }
    }
    if (e.target.classList.contains('notes-input')) {
      const id = e.target.id.slice(1);
      counts[id] = { ...counts[id], notes: e.target.value };
      autoSave();
    }
  }, true);

  document.getElementById('searchBox').addEventListener('input', () => {
    const term = document.getElementById('searchBox').value.toLowerCase();
    document.querySelectorAll('.item-card').forEach(c => {
      c.style.display = c.textContent.toLowerCase().includes(term) ? 'block' : 'none';
    });
  });

  document.getElementById('btnUncounted').onclick = () => {
    document.querySelectorAll('.item-card').forEach(c => {
      const id = c.dataset.id;
      c.style.display = (counts[id] && (counts[id].counted || counts[id].notfound)) ? 'none' : 'block';
    });
  };

  document.getElementById('btnShowAll').onclick = () => {
    document.querySelectorAll('.item-card').forEach(c => c.style.display = 'block');
  };

  document.getElementById('btnExport').onclick = () => {
    let csv = 'Part,Description,Category,Prev,Count,Notes,Status,Time\n';
    itemOrder.forEach(id => {
      if (!items[id]) return;
      const it = items[id];
      const st = counts[id] || {};
      const status = st.notfound ? 'NOT FOUND' : st.counted ? 'COUNTED' : 'PENDING';
      const notes = (st.notes || '').replace(/"/g, '""');
      csv += `"${it.part}","${it.desc}","${it.cat}","${it.prev}","${st.count||''}","${notes}","${status}","${st.timestamp||''}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  document.getElementById('btnReset').onclick = () => {
    if (confirm('Reset ALL data? This cannot be undone!')) {
      localStorage.clear();
      location.reload();
    }
  };

  document.getElementById('btnAddItem').onclick = () => {
    const part = document.getElementById('newPart').value.trim();
    const desc = document.getElementById('newDesc').value.trim();
    const cat  = document.getElementById('newCat').value.trim() || 'Custom';

    if (!part || !desc) { alert('Part Number and Description required!'); return; }

    const norm = part.toUpperCase();
    const existing = Array.from(document.querySelectorAll('.item-card'))
                     .find(c => c.dataset.part.toUpperCase() === norm);

    if (existing) {
      existing.scrollIntoView({behavior:'smooth', block:'center'});
      existing.classList.add('highlight');
      setTimeout(() => existing.classList.remove('highlight'), 1000);
      return;
    }

    const id = nextId++;
    items[id] = {part, desc, cat, prev:'NEW'};
    itemOrder.push(id);
    const card = createCard(id);
    card.classList.add('custom');
    document.getElementById('items').appendChild(card);
    autoSave();

    document.getElementById('newPart').value = '';
    document.getElementById('newDesc').value = '';
    document.getElementById('newCat').value = '';
    card.scrollIntoView({behavior:'smooth'});
  };
});
</script>
</body>
</html>
